require 'jirafe/monkey'
require 'jirafe/configuration'
require 'jirafe/request'
require 'jirafe/response'
require 'jirafe/version'
{{#models}}
{{#model}}
require 'jirafe/{{filename}}'
{{/model}}
{{/models}}
{{#apis}}
require 'jirafe/{{filename}}'
{{/apis}}
require 'logger'

module Jirafe

  class << self
    attr_accessor :logger

    # A Jirafe configuration object. Must act like a hash and return sensible
    # values for all Jirafe configuration options. See Jirafe::Configuration.
    attr_accessor :configuration

    attr_accessor :resources

    # Call this method to modify defaults in your initializers.
    #
    # @example
    #   Jirafe.configure do |config|
    #     config.api_key = '1234567890abcdef'     # required
    #     config.username = 'wordlover'           # optional, but needed for user-related functions
    #     config.password = 'i<3words'            # optional, but needed for user-related functions
    #     config.format = 'json'                  # optional, defaults to 'json'
    #   end
    #
    def configure
      self.configuration ||= Configuration.new
      yield(configuration) if block_given?

      # Configure logger.  Default to use Rails
      self.logger ||= configuration.logger || (defined?(Rails) ? Rails.logger : Logger.new(STDOUT))

      # remove :// from scheme
      configuration.scheme.sub!(/:\/\//, '')

      # remove http(s):// and anything after a slash
      configuration.host.sub!(/https?:\/\//, '')
      configuration.host = configuration.host.split('/').first

      # Add leading and trailing slashes to base_path
      configuration.base_path = "/#{configuration.base_path}".gsub(/\/+/, '/')
      configuration.base_path = "" if configuration.base_path == "/"
    end

    def authenticated?
      Jirafe.configuration.auth_token.present?
    end

    def de_authenticate
      Jirafe.configuration.auth_token = nil
    end

    def authenticate
      return if Jirafe.authenticated?

      if Jirafe.configuration.username.blank? || Jirafe.configuration.password.blank?
        raise ClientError, "Username and password are required to authenticate."
      end

      request = Jirafe::Request.new(
        :get,
        "account/authenticate/{username}",
        :params => {
          :username => Jirafe.configuration.username,
          :password => Jirafe.configuration.password
        }
      )

      response_body = request.response.body
      Jirafe.configuration.auth_token = response_body['token']
    end

  end

  class ServerError < StandardError
  end

  class ClientError < StandardError
  end

end
